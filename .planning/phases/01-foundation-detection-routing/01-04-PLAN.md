---
phase: 01-foundation-detection-routing
plan: 04
type: execute
wave: 3
depends_on: [01-03]
files_modified: [test/foundation-detection.test.sh, agents/gsd-executor.md]
autonomous: false
must_haves:
  truths:
    - "Domain detection correctly identifies all major technology domains"
    - "Fallback works seamlessly when specialists unavailable"
    - "System maintains v1.20 behavior when feature disabled"
  artifacts:
    - path: "test/foundation-detection.test.sh"
      provides: "End-to-end validation tests"
      min_lines: 100
    - path: "agents/gsd-executor.md"
      provides: "Complete foundation implementation"
      contains: "All detection, routing, and adapter sections"
  key_links:
    - from: "test script"
      to: "gsd-executor functions"
      via: "source and function calls"
      pattern: "source.*gsd-executor|detect_specialist_for_task"
---

<objective>
Validate the foundation implementation with comprehensive tests and verify all Phase 1 requirements are met.

Purpose: Ensure domain detection, availability checking, routing decisions, and fallback mechanisms work correctly before proceeding to Phase 2.
Output: Test suite validating all foundation capabilities and verified working system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-detection-routing/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-foundation-detection-routing/01-01-SUMMARY.md
@.planning/phases/01-foundation-detection-routing/01-02-SUMMARY.md
@.planning/phases/01-foundation-detection-routing/01-03-SUMMARY.md

# Implementation to test
@agents/gsd-executor.md
@.planning/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive test suite</name>
  <files>test/foundation-detection.test.sh</files>
  <action>
Create a test script that validates all Phase 1 requirements:

1. Domain Detection Tests:
   ```bash
   #!/bin/bash
   # Test domain detection for all major domains

   test_python_detection() {
     result=$(detect_specialist_for_task "Create a FastAPI endpoint with SQLAlchemy models")
     assert_equals "python-pro" "$result" "Python domain detection"
   }

   test_typescript_detection() {
     result=$(detect_specialist_for_task "Build React component with TypeScript and Next.js routing")
     assert_equals "typescript-pro" "$result" "TypeScript domain detection"
   }

   test_kubernetes_detection() {
     result=$(detect_specialist_for_task "Deploy application to K8s cluster with Helm charts")
     assert_equals "kubernetes-specialist" "$result" "Kubernetes domain detection"
   }

   test_no_domain_match() {
     result=$(detect_specialist_for_task "Update the documentation in README.md")
     assert_equals "" "$result" "No domain match returns empty"
   }
   ```

2. Availability Checking Tests:
   ```bash
   test_specialist_available() {
     # Create mock specialist
     mkdir -p ~/.claude/agents/
     echo "mock" > ~/.claude/agents/python-pro.md
     result=$(check_specialist_availability "python-pro")
     assert_equals "available" "$result" "Specialist availability check"
     rm ~/.claude/agents/python-pro.md
   }

   test_specialist_unavailable() {
     result=$(check_specialist_availability "nonexistent-specialist")
     assert_contains "unavailable" "$result" "Unavailable specialist detection"
   }
   ```

3. Routing Decision Tests:
   ```bash
   test_delegation_decision() {
     USE_SPECIALISTS="true"
     MIN_FILES="3"
     result=$(make_routing_decision "Create Python API with 5 endpoints" "5")
     assert_contains "delegate" "$result" "Delegation when criteria met"
   }

   test_fallback_decision() {
     USE_SPECIALISTS="true"
     result=$(make_routing_decision "Fix typo in comment" "1")
     assert_contains "direct" "$result" "Direct execution for simple tasks"
   }

   test_disabled_specialists() {
     USE_SPECIALISTS="false"
     result=$(make_routing_decision "Complex Python refactoring" "10")
     assert_contains "direct" "$result" "Direct when feature disabled"
   }
   ```

4. Adapter Function Tests:
   ```bash
   test_task_adapter() {
     prompt=$(gsd_task_adapter "Create API" "Build REST endpoint" "curl test passes" "Returns 200" "API Phase" "None")
     assert_contains "Build REST endpoint" "$prompt" "Task adapter includes action"
     assert_contains "curl test passes" "$prompt" "Task adapter includes verification"
   }

   test_result_adapter() {
     output="Files modified: src/api.py\nVerification results: All tests pass\nDeviations: None"
     result=$(gsd_result_adapter "$output")
     assert_contains "src/api.py" "$result" "Result adapter extracts files"
   }
   ```

5. End-to-end Integration Test:
   ```bash
   test_full_flow() {
     # Test complete flow from detection to routing
     # Simulate a task that should delegate
     # Verify all components work together
   }
   ```

Include test runner and assertion helpers at the top of the file.
  </action>
  <verify>test -f test/foundation-detection.test.sh && bash test/foundation-detection.test.sh</verify>
  <done>Test suite created and all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add backward compatibility validation</name>
  <files>test/foundation-detection.test.sh</files>
  <action>
Add specific tests to ensure v1.20 compatibility:

1. Test with default config (use_specialists=false):
   ```bash
   test_v120_compatibility() {
     # Reset to default config
     cp .planning/config.json .planning/config.json.bak
     # Ensure use_specialists is false

     # Run detection - should always return direct
     USE_SPECIALISTS="false"
     for task in "Python API" "Deploy K8s" "React component"; do
       result=$(make_routing_decision "$task" "10")
       assert_contains "direct" "$result" "v1.20 compatibility for: $task"
     done

     # Restore config
     mv .planning/config.json.bak .planning/config.json
   }
   ```

2. Test with no VoltAgent installed:
   ```bash
   test_no_voltagent() {
     # Temporarily move specialists directory
     if [ -d ~/.claude/agents ]; then
       mv ~/.claude/agents ~/.claude/agents.bak
     fi

     # All detections should gracefully fallback
     result=$(check_specialist_availability "python-pro")
     assert_contains "unavailable" "$result" "Works without VoltAgent"

     # Restore if existed
     if [ -d ~/.claude/agents.bak ]; then
       mv ~/.claude/agents.bak ~/.claude/agents
     fi
   }
   ```

3. Test with partial VoltAgent installation:
   ```bash
   test_partial_installation() {
     # Some specialists available, others not
     # Should delegate only when available
   }
   ```

Run all compatibility tests to ensure zero breaking changes.
  </action>
  <verify>grep -n "test_v120_compatibility" test/foundation-detection.test.sh</verify>
  <done>Backward compatibility tests added and passing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 Foundation implementation including:
- Domain detection with 127+ specialist patterns
- Dynamic specialist registry population
- Availability checking with filesystem verification
- Routing decisions based on complexity and availability
- Task and result adapter functions
- Configuration support with feature flags
- Comprehensive test suite
- Backward compatibility validation
  </what-built>
  <how-to-verify>
1. Run the test suite:
   ```bash
   bash test/foundation-detection.test.sh
   ```

2. Check domain detection manually:
   ```bash
   # Source the functions
   source agents/gsd-executor.md

   # Test detection
   detect_specialist_for_task "Create Python FastAPI endpoint"
   detect_specialist_for_task "Deploy to Kubernetes"
   detect_specialist_for_task "Build React component"
   ```

3. Verify config structure:
   ```bash
   cat .planning/config.json | grep -A5 "use_specialists"
   ```

4. Confirm backward compatibility:
   - Set use_specialists to false
   - Run any existing workflow
   - Should work identically to v1.20
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass and detection works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- All domain detection patterns work correctly
- Specialist availability checking functions properly
- Routing decisions follow complexity thresholds
- Adapter functions translate formats correctly
- System falls back gracefully when specialists unavailable
- v1.20 workflows continue working unchanged
</verification>

<success_criteria>
- Test suite passes all assertions
- Python tasks map to python-pro specialist
- Kubernetes tasks map to kubernetes-specialist
- Simple tasks stay with direct execution
- use_specialists=false preserves v1.20 behavior
- System works with zero VoltAgent specialists installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-detection-routing/01-04-SUMMARY.md`
</output>