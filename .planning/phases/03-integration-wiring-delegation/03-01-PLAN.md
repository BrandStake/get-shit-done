---
phase: 03-integration-wiring-delegation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [agents/gsd-executor.md]
autonomous: true

must_haves:
  truths:
    - "When routing decision is 'delegate', gsd-executor invokes specialist via Task tool"
    - "Specialists receive project context (CLAUDE.md, skills) in their execution environment"
    - "Specialist execution output is captured and parsed by gsd-executor"
    - "Specialists execute in isolated context window with project conventions loaded"
  artifacts:
    - path: "agents/gsd-executor.md"
      provides: "Task tool invocation pattern in execute_tasks flow"
      contains: "Task\\(subagent_type=\"\\$\\{SPECIALIST\\}\""
      min_lines: 30
    - path: "agents/gsd-executor.md"
      provides: "Context injection logic building files_to_read list"
      contains: "FILES_TO_READ=\"CLAUDE.md"
      min_lines: 20
  key_links:
    - from: "execute_tasks step"
      to: "Task tool"
      via: "Task() invocation with subagent_type parameter"
      pattern: "Task\\(.*subagent_type="
    - from: "Task tool prompt"
      to: "project context files"
      via: "files_to_read parameter with CLAUDE.md and skills"
      pattern: "files_to_read.*CLAUDE\\.md"
    - from: "Task tool output"
      to: "gsd_result_adapter"
      via: "captured in SPECIALIST_OUTPUT variable"
      pattern: "SPECIALIST_OUTPUT.*gsd_result_adapter"
---

<objective>
Wire Phase 1's routing logic and Phase 2's adapters into actual specialist invocation via Claude Code's Task tool. Replace placeholder delegation code with real Task() calls that invoke VoltAgent specialists with project context.

Purpose: Completes the delegation flow by connecting detection → adapter → invocation → parsing. This is the critical integration point that makes specialists actually execute tasks instead of just preparing prompts.

Output: Working end-to-end delegation where gsd-executor can route a task to python-pro, invoke it via Task tool with CLAUDE.md and skills injected, capture the output, and parse it back to GSD format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-wiring-delegation/03-RESEARCH.md

# Prior phase context (dependency chain)
@.planning/phases/01-foundation-detection-routing/01-03-SUMMARY.md
@.planning/phases/02-adapters-context-translation/02-01-SUMMARY.md

# Implementation target
@agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Task tool invocation in execute_tasks flow</name>
  <files>agents/gsd-executor.md</files>
  <action>
Replace the TODO placeholder in the execute_tasks flow (lines ~1358-1369) with actual Task tool invocation pattern. Use the same pattern verified in 50+ GSD workflow files (workflows/execute-phase.md, commands/gsd/*.md).

Implementation requirements:
1. Extract specialist name from ROUTE_DETAIL when ROUTE_ACTION = "delegate"
2. Generate specialist prompt using existing gsd_task_adapter function
3. Build FILES_TO_READ list with mandatory project context:
   - Always include: CLAUDE.md (project conventions)
   - If .agents/skills/ exists: include .agents/skills/ (skill rules)
   - Append TASK_FILES from <files> element (task-specific context)
4. Invoke Task tool with parameters:
   - subagent_type="${SPECIALIST}" (e.g., "python-pro")
   - model="${EXECUTOR_MODEL}" (inherit from execute-phase config)
   - prompt with <task_context> and <files_to_read> sections
   - description="Task ${PHASE}-${PLAN}-${TASK_NUM} (${SPECIALIST})"
5. Capture output in SPECIALIST_OUTPUT variable
6. Parse output using existing gsd_result_adapter function
7. Extract files_modified, verification_status, commit_message from parsed result

Critical implementation details from research:
- Use identical Task() pattern to existing gsd-executor invocations (subagent_type is only difference)
- files_to_read parameter triggers automatic @-reference expansion and skill loading
- Do NOT duplicate CLAUDE.md content in prompt (redundant, wastes tokens)
- Trust that Task tool handles skill injection automatically when files_to_read includes .agents/skills/
- Prompt structure: <task_context> contains specialist prompt from adapter, <files_to_read> lists files for context injection

Remove the fallback log messages ("delegation pending Phase 3", "executing directly") since real delegation now works.
  </action>
  <verify>
1. grep 'Task(' agents/gsd-executor.md | grep 'subagent_type' confirms Task tool invocation present
2. grep 'FILES_TO_READ.*CLAUDE.md' agents/gsd-executor.md confirms context injection
3. grep 'gsd_result_adapter.*SPECIALIST_OUTPUT' agents/gsd-executor.md confirms output parsing
4. No TODO comments remain in delegation path
  </verify>
  <done>
execute_tasks flow contains complete Task tool invocation replacing placeholder code. Specialist receives CLAUDE.md and skills via files_to_read. Output captured and parsed via gsd_result_adapter. No fallback messages remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add checkpoint passthrough logic for specialist checkpoints</name>
  <files>agents/gsd-executor.md</files>
  <action>
After Task tool invocation (after capturing SPECIALIST_OUTPUT), add checkpoint detection and passthrough logic. Specialists use the same checkpoint protocol as gsd-executor - no translation needed.

Implementation requirements:
1. Check SPECIALIST_OUTPUT for checkpoint marker: "## CHECKPOINT REACHED"
2. If checkpoint detected:
   - Log checkpoint occurrence to delegation.log: "$(date),${PHASE}-${PLAN},Task $TASK_NUM,$TASK_NAME,$SPECIALIST,checkpoint"
   - Echo SPECIALIST_OUTPUT unchanged (pass through to user)
   - Return immediately (exit execute_tasks flow)
3. If no checkpoint, proceed with normal result parsing and commit

Why no translation layer: Specialists are Claude Code subagents inheriting same checkpoint protocol (checkpoint:human-verify, checkpoint:decision, checkpoint:human-action). gsd-executor just passes through the structured message. Continuation agent will resume normally using same checkpoint handling as non-delegated tasks.

Add comment documenting this pattern for future maintainers.
  </action>
  <verify>
1. grep 'CHECKPOINT REACHED' agents/gsd-executor.md confirms checkpoint detection
2. grep 'checkpoint.*delegation.log' agents/gsd-executor.md confirms checkpoint logging
3. Checkpoint passthrough code appears BEFORE result parsing (early exit path)
  </verify>
  <done>
Checkpoint detection logic added after Task tool invocation. When specialist returns checkpoint, gsd-executor logs occurrence, passes through message unchanged, and exits. No checkpoint translation layer present (specialists use same protocol).
  </done>
</task>

<task type="auto">
  <name>Task 3: Document context injection mechanism in project_context section</name>
  <files>agents/gsd-executor.md</files>
  <action>
Enhance the <project_context> section (lines 19-32) to document how specialists receive project context when delegated via Task tool. Current section explains CLAUDE.md and skills loading for gsd-executor itself - extend to cover delegation context injection.

Add new subsection after existing content:

**Specialist Context Injection (Delegation):**

When delegating to VoltAgent specialists (python-pro, typescript-pro, etc.), gsd-executor injects project context via Task tool's files_to_read parameter:
1. CLAUDE.md - Project instructions, conventions, security requirements loaded automatically
2. .agents/skills/ - Project-specific skills and rules applied during specialist execution
3. Task files - Files listed in <files> element for task-specific context

The Task tool handles @-reference expansion and skill loading identically to how gsd-executor receives context. Specialists execute in isolated 200k context window with project conventions pre-loaded, ensuring compliance with CLAUDE.md and skill rules without duplicating content in prompts.

This documentation helps future maintainers understand why CLAUDE.md isn't manually appended to specialist prompts (automatic injection via files_to_read).
  </action>
  <verify>
1. grep -A 10 'Specialist Context Injection' agents/gsd-executor.md confirms new documentation
2. Documentation mentions files_to_read parameter and automatic injection
3. Explains isolation (200k context window) and automatic skill loading
  </verify>
  <done>
project_context section documents specialist context injection via files_to_read parameter. Explains CLAUDE.md and skills auto-loading for delegated tasks. Clear rationale for why content isn't duplicated in prompts.
  </done>
</task>

</tasks>

<verification>
**Integration verification:**
1. Execute test task delegation flow (mock or real specialist if available)
2. Verify CLAUDE.md referenced in Task tool invocation
3. Verify gsd_result_adapter called with SPECIALIST_OUTPUT
4. Verify checkpoint passthrough triggers on "## CHECKPOINT REACHED" marker
5. Confirm no TODO placeholders remain in delegation path

**Code quality:**
1. Task tool invocation matches pattern in workflows/execute-phase.md
2. Context injection follows files_to_read parameter convention
3. Checkpoint passthrough is early-exit pattern (before result parsing)
</verification>

<success_criteria>
1. execute_tasks flow invokes Task tool with subagent_type="${SPECIALIST}" when ROUTE_ACTION = "delegate"
2. files_to_read parameter includes CLAUDE.md, .agents/skills/, and TASK_FILES
3. SPECIALIST_OUTPUT captured and passed to gsd_result_adapter
4. Checkpoint detection logic passes through specialist checkpoints unchanged
5. Documentation explains specialist context injection mechanism
6. No placeholder code remains (TODO comments removed)
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-wiring-delegation/03-01-SUMMARY.md`
</output>
