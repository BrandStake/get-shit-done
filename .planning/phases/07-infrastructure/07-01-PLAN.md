---
phase: 07-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/lib/agents.cjs
  - get-shit-done/bin/gsd-tools.cjs
  - .claude/get-shit-done/workflows/execute-phase.md
autonomous: true
requirements: [DISC-01, DISC-02, DISC-03, DISC-04]

must_haves:
  truths:
    - "gsd-tools can enumerate agents from ~/.claude/agents/ directory"
    - "Agent enumeration excludes GSD system agents (gsd-*)"
    - "available_agents.md contains specialist names and descriptions"
    - "Orchestrator validates specialist availability before spawning"
  artifacts:
    - path: "get-shit-done/bin/lib/agents.cjs"
      provides: "Agent enumeration logic with GSD filter"
      exports: ["cmdEnumerateAgents", "generateAvailableAgentsMd"]
      min_lines: 80
    - path: "get-shit-done/bin/gsd-tools.cjs"
      provides: "CLI router for agents enumerate command"
      contains: "case 'agents':"
    - path: ".planning/available_agents.md"
      provides: "Generated specialist roster"
      contains: "# Available Specialists"
    - path: ".claude/get-shit-done/workflows/execute-phase.md"
      provides: "Specialist validation before spawn"
      contains: "agents enumerate"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.cjs"
      to: "get-shit-done/bin/lib/agents.cjs"
      via: "require('./lib/agents.cjs')"
      pattern: "const agents = require.*agents"
    - from: ".claude/get-shit-done/workflows/execute-phase.md"
      to: "gsd-tools.cjs agents enumerate"
      via: "Bash command invocation"
      pattern: "gsd-tools.*agents enumerate"
    - from: "lib/agents.cjs"
      to: "~/.claude/agents/"
      via: "fs.readdirSync enumeration"
      pattern: "readdirSync.*\\.claude/agents"
---

<objective>
Implement agent discovery infrastructure enabling orchestrators to enumerate available VoltAgent specialists and validate their availability before spawning.

Purpose: Fix v1.21 broken delegation by moving specialist discovery to orchestrator layer where Task tool access exists. Without this, planners can't know which specialists exist, and orchestrators can't validate before spawning.

Output: Working `gsd-tools agents enumerate` command generating available_agents.md, plus validation logic in execute-phase orchestrator.
</objective>

<execution_context>
@/Users/matte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-infrastructure/07-RESEARCH.md
@get-shit-done/bin/gsd-tools.cjs
@get-shit-done/bin/lib/commit.cjs
@.claude/get-shit-done/workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement agent enumeration in gsd-tools</name>
  <files>
    get-shit-done/bin/lib/agents.cjs
    get-shit-done/bin/gsd-tools.cjs
  </files>
  <action>
Create new agents.cjs module in get-shit-done/bin/lib/ directory implementing agent discovery:

**agents.cjs exports:**
- `cmdEnumerateAgents(cwd, outputPath)`: Main entry point called by gsd-tools CLI
- `enumerateAgents(agentsDir)`: Core enumeration returning agent metadata array
- `extractAgentMetadata(filePath)`: Parse frontmatter (name, description) from agent .md file
- `filterGsdSystemAgents(agentFiles)`: Filter out gsd-* prefix agents
- `generateAvailableAgentsMd(agents, timestamp)`: Generate markdown output

**Implementation details:**
- Agents directory: `path.join(os.homedir(), '.claude', 'agents')`
- Filter pattern: `!f.startsWith('gsd-')` to exclude GSD system agents
- Frontmatter parsing: Use regex `/^name:\s*(.+)$/m` and `/^description:\s*(.+)$/m` (no dependencies)
- Fallback: If name missing, use filename; if description missing, use "Specialist agent"
- Output format: Markdown with header, specialist list, usage instructions

**Update gsd-tools.cjs CLI router:**
- Add `case 'agents':` to command router after existing commands
- Parse subcommand: `const subcommand = args[1]`
- Handle `enumerate` subcommand: extract --output flag or default to `.planning/available_agents.md`
- Call `agents.cmdEnumerateAgents(cwd, outputPath)`
- Require statement: `const agents = require('./lib/agents.cjs');` at top with other imports

**Error handling:**
- If ~/.claude/agents/ doesn't exist, log warning to stderr and create empty roster
- If agent file has invalid frontmatter, use filename as fallback
- Create output directory if doesn't exist: `fs.mkdirSync(path.dirname(outputPath), {recursive: true})`

**Follow existing GSD patterns:**
- Module structure matches lib/commit.cjs (exports object with functions)
- Error logging to stderr, success messages to stdout
- JSON output option for programmatic use (future-proofing)
- Use synchronous fs operations (consistent with other gsd-tools modules)
  </action>
  <verify>
    <automated>
cd /Users/matte/Documents/workspace/get-shit-done && \
node get-shit-done/bin/gsd-tools.cjs agents enumerate --output .planning/available_agents.md && \
[ -f .planning/available_agents.md ] && \
grep -q "# Available Specialists" .planning/available_agents.md && \
! grep -q "gsd-planner" .planning/available_agents.md && \
! grep -q "gsd-executor" .planning/available_agents.md
    </automated>
    <manual>
Verify available_agents.md contains:
1. Header with generation timestamp
2. List of installed specialists (VoltAgent agents only)
3. NO gsd-* system agents in roster
4. Usage instructions with YAML example
    </manual>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>
Command `gsd-tools agents enumerate` successfully creates available_agents.md with specialist roster, GSD system agents filtered out, frontmatter metadata extracted from agent files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add specialist validation to execute-phase orchestrator</name>
  <files>
    .claude/get-shit-done/workflows/execute-phase.md
  </files>
  <action>
Update execute-phase.md orchestrator to validate specialist availability before spawning.

**Add to load_project_state step (after init call):**
```bash
# Generate fresh agent roster for specialist validation
node "${GSD_TOOLS}" agents enumerate --output .planning/available_agents.md
```

**Add new validation step before task execution (in spawn_specialist section):**

Create `validate_specialist_availability` step that:
1. Reads specialist field from task frontmatter
2. If specialist is null or empty, return "gsd-executor" (direct execution)
3. If specialist assigned, check against available_agents.md:
   ```bash
   if ! grep -q "^- \*\*${SPECIALIST}\*\*:" .planning/available_agents.md; then
     echo "Warning: Specialist '${SPECIALIST}' not available, falling back to gsd-executor" >&2
     SPECIALIST="gsd-executor"
   fi
   ```
4. Return validated specialist name for spawning

**Update spawn logic to use validation:**
- Before calling Task() with subagent_type, call validate_specialist_availability
- Use returned specialist name (may be fallback to gsd-executor)
- Log warning when fallback occurs for observability

**Location in execute-phase.md:**
- Insert validation step in execution_flow section, after `read_task` and before `spawn_specialist`
- Update spawn_specialist step to reference validation

**Error handling:**
- If available_agents.md missing, log error and fall back to gsd-executor for all tasks
- If specialist field malformed in frontmatter, treat as null (direct execution)

**Follow orchestrator patterns:**
- Use structured step tags: `<step name="validate_specialist">`
- Include error handling subsection
- Document fallback behavior clearly
  </action>
  <verify>
    <automated>
cd /Users/matte/Documents/workspace/get-shit-done && \
grep -q "agents enumerate" .claude/get-shit-done/workflows/execute-phase.md && \
grep -q "validate_specialist" .claude/get-shit-done/workflows/execute-phase.md && \
grep -q "falling back to gsd-executor" .claude/get-shit-done/workflows/execute-phase.md
    </automated>
    <manual>
Verify execute-phase.md contains:
1. Agent enumeration call in load_project_state
2. validate_specialist_availability step before spawning
3. Fallback logic when specialist unavailable
4. Error handling for missing available_agents.md
    </manual>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>
execute-phase.md orchestrator validates specialist availability before spawning, falls back to gsd-executor when specialist unavailable or missing, generates fresh agent roster at start of execution.
  </done>
</task>

</tasks>

<verification>
End-to-end validation:

1. **Agent enumeration:**
   ```bash
   node gsd-tools.cjs agents enumerate
   cat .planning/available_agents.md
   # Verify: Contains VoltAgent specialists, excludes gsd-*, includes descriptions
   ```

2. **GSD filter:**
   ```bash
   # If ~/.claude/agents/ has gsd-planner.md and python-pro.md:
   grep "python-pro" .planning/available_agents.md  # Should find
   grep "gsd-planner" .planning/available_agents.md  # Should NOT find
   ```

3. **Validation logic:**
   ```bash
   grep -A 5 "validate_specialist" .claude/get-shit-done/workflows/execute-phase.md
   # Verify: Checks available_agents.md, falls back to gsd-executor
   ```

4. **Fresh enumeration:**
   ```bash
   # Verify execute-phase.md calls agents enumerate early in workflow
   grep "agents enumerate" .claude/get-shit-done/workflows/execute-phase.md
   ```
</verification>

<success_criteria>
- [ ] `gsd-tools agents enumerate` command exists and executes without errors
- [ ] available_agents.md generated with specialist roster
- [ ] GSD system agents (gsd-*) filtered from roster
- [ ] Agent frontmatter (name, description) extracted correctly
- [ ] execute-phase.md generates fresh agent roster before execution
- [ ] execute-phase.md validates specialist availability before spawning
- [ ] Fallback to gsd-executor when specialist unavailable
- [ ] All 4 DISC requirements covered (DISC-01, DISC-02, DISC-03, DISC-04)
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure/07-01-SUMMARY.md`
</output>
