---
phase: 02-adapters-context-translation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [agents/gsd-executor.md]
autonomous: true
must_haves:
  truths:
    - "gsd_task_adapter() prunes verbose task descriptions to prevent token overflow"
    - "gsd_task_adapter() injects GSD execution rules into specialist prompts"
    - "Specialists receive clear output format requirements with JSON schema and text fallback"
    - "Task context remains focused and essential (no full state dumps)"
  artifacts:
    - path: "agents/gsd-executor.md"
      provides: "Enhanced gsd_task_adapter() with context pruning and rule injection"
      contains: "prune_task_context|generate_gsd_rules_section"
  key_links:
    - from: "gsd_task_adapter()"
      to: "prune_task_context()"
      via: "function call before prompt generation"
      pattern: "pruned_action=.*prune_task_context"
    - from: "gsd_task_adapter()"
      to: "generate_gsd_rules_section()"
      via: "function call in prompt template"
      pattern: "generate_gsd_rules_section"
---

<objective>
Enhance gsd_task_adapter() with context pruning and GSD rule injection to prevent token overflow and ensure specialists follow GSD protocols.

Purpose: Specialists need focused context (not full state dumps) and clear execution rules to produce GSD-compatible output
Output: Enhanced gsd_task_adapter() that prunes context intelligently and injects standardized GSD rules
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapters-context-translation/02-RESEARCH.md

# Existing implementation from Phase 1
@agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context pruning to gsd_task_adapter()</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Enhance the gsd_task_adapter() function (currently at line 737) with context pruning logic:

    1. Add prune_task_context() helper function BEFORE gsd_task_adapter():
       - Takes task_action as input
       - If action > 500 characters, keeps first 3 paragraphs
       - If still too long, truncates with ellipsis
       - Returns pruned action text

    2. Modify gsd_task_adapter() to use pruning:
       - Call prune_task_context() on task_action before using in prompt
       - Prune task_files list if > 10 files (keep first 10)
       - Never include @-references content (just reference names)

    Use the exact implementation from research (02-RESEARCH.md lines 291-312) for consistency.

    Important: Do NOT reimplement the entire function. Only add the pruning logic and integrate it.
  </action>
  <verify>grep -A 20 "prune_task_context()" agents/gsd-executor.md | head -25</verify>
  <done>Context pruning function exists and is called within gsd_task_adapter()</done>
</task>

<task type="auto">
  <name>Task 2: Add GSD rule injection to specialist prompts</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Add GSD rule injection to the gsd_task_adapter() function:

    1. Add generate_gsd_rules_section() helper function AFTER prune_task_context():
       - Returns heredoc with GSD execution rules
       - Includes atomic commit requirements
       - Specifies deviation reporting format
       - Provides both JSON and text output templates

    2. Modify gsd_task_adapter() prompt template to include rules:
       - Call generate_gsd_rules_section() after task description
       - Place before "Please return results in the following format" section
       - Ensure rules are prominent in the prompt structure

    Use the exact implementation from research (02-RESEARCH.md lines 321-376) for the rules section.

    The prompt should flow: Task → Files → Action → Verification → GSD Rules → Output Format
  </action>
  <verify>grep -A 5 "generate_gsd_rules_section" agents/gsd-executor.md | head -10</verify>
  <done>GSD rules section is injected into specialist prompts with clear formatting requirements</done>
</task>

<task type="auto">
  <name>Task 3: Update output format instructions with enhanced schema</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Update the output format section in gsd_task_adapter() to align with GSD rules:

    1. Replace the current "Please return results in the following format" section
    2. Include both JSON schema (preferred) and text format (fallback)
    3. Add the "deviations" field to the JSON schema
    4. Ensure commit_message field is included
    5. Update text format to match the structured format from generate_gsd_rules_section()

    The output format should match what's defined in the GSD rules for consistency.
    Specialists should see the same format requirements in both places.
  </action>
  <verify>grep -B 2 -A 10 '"deviations"' agents/gsd-executor.md | head -15</verify>
  <done>Output format includes deviations field and matches GSD rule requirements</done>
</task>

</tasks>

<verification>
# Function definitions exist
grep -q "prune_task_context()" agents/gsd-executor.md && echo "✓ Context pruning function exists"
grep -q "generate_gsd_rules_section()" agents/gsd-executor.md && echo "✓ GSD rules function exists"

# Functions are called in adapter
grep -q "prune_task_context" agents/gsd-executor.md | grep -v "^prune_task_context()" && echo "✓ Pruning is called"
grep -q "generate_gsd_rules_section" agents/gsd-executor.md | grep -v "^generate_gsd_rules_section()" && echo "✓ Rules are injected"

# Deviations field in schema
grep -q '"deviations"' agents/gsd-executor.md && echo "✓ Deviations field in output schema"
</verification>

<success_criteria>
- Context pruning function exists and truncates verbose actions to 500 chars
- GSD rules are injected into every specialist prompt
- Output format includes deviations field for tracking off-plan work
- No full state dumps are sent to specialists (focused context only)
- Both JSON and text output formats are documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapters-context-translation/02-01-SUMMARY.md`
</output>