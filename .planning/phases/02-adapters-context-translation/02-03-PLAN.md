---
phase: 02-adapters-context-translation
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified: [test/adapter-context.test.sh]
autonomous: true
must_haves:
  truths:
    - "Test suite validates context pruning truncates verbose descriptions"
    - "Test suite validates GSD rules are injected into prompts"
    - "Test suite validates multi-layer parsing handles various output formats"
    - "Test suite validates deviation extraction and classification"
  artifacts:
    - path: "test/adapter-context.test.sh"
      provides: "Comprehensive test suite for Phase 2 adapter enhancements"
      min_lines: 400
      contains: "test_context_pruning|test_gsd_rule_injection|test_multilayer_parsing|test_deviation_extraction"
  key_links:
    - from: "test/adapter-context.test.sh"
      to: "agents/gsd-executor.md"
      via: "Function extraction from markdown"
      pattern: "sed.*gsd-executor.md.*eval"
---

<objective>
Create comprehensive test suite validating all Phase 2 adapter enhancements: context pruning, rule injection, multi-layer parsing, and deviation extraction.

Purpose: Ensure adapter enhancements work correctly across various scenarios and edge cases
Output: Test suite with 30+ tests covering all ADPT requirements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapters-context-translation/02-RESEARCH.md

# Reference Phase 1 test structure
@test/foundation-detection.test.sh

# Functions to test
@agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test suite structure and context pruning tests</name>
  <files>test/adapter-context.test.sh</files>
  <action>
    Create test/adapter-context.test.sh with:

    1. Test infrastructure (copy from foundation-detection.test.sh):
       - Color output helpers (RED, GREEN, YELLOW, NC)
       - Assertion functions (assert_eq, assert_contains, assert_not_contains)
       - Function extraction from gsd-executor.md
       - Test runner with summary

    2. Context pruning test suite (8-10 tests):
       - Test short action (< 500 chars) passes through unchanged
       - Test long action (> 500 chars) gets truncated
       - Test very long action gets ellipsis
       - Test file list pruning (> 10 files)
       - Test empty/null action handling
       - Test multiline action with paragraphs
       - Test action with special characters
       - Test pruning preserves essential info

    3. GSD rule injection test suite (6-8 tests):
       - Test rules section is added to prompt
       - Test atomic commit rules present
       - Test deviation reporting rules present
       - Test JSON output format present
       - Test text output format present
       - Test rules appear after task description
  </action>
  <verify>bash test/adapter-context.test.sh 2>&1 | grep -E "(Context Pruning Tests|GSD Rule Injection)" | head -5</verify>
  <done>Test file created with context pruning and rule injection test suites</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-layer parsing and deviation extraction tests</name>
  <files>test/adapter-context.test.sh</files>
  <action>
    Add to test/adapter-context.test.sh:

    1. Multi-layer parsing test suite (10-12 tests):
       - Test valid JSON in markdown code blocks
       - Test direct JSON object parsing
       - Test structured text format (FILES MODIFIED:, VERIFICATION:)
       - Test bullet list file extraction
       - Test mixed format with partial JSON
       - Test completely unstructured output
       - Test empty/null output handling
       - Test malformed JSON fallback
       - Test verification status extraction (passed/failed/unknown)
       - Test commit message extraction

    2. Deviation extraction test suite (8-10 tests):
       - Test explicit JSON deviations field
       - Test Rule 1 bug detection (fixed bug, corrected)
       - Test Rule 2 missing detection (added validation)
       - Test Rule 3 blocking detection (blocked by)
       - Test multiple deviations in one output
       - Test no deviations case
       - Test deviation with detailed description
       - Test deviation classification accuracy

    3. Schema validation test suite (6-8 tests):
       - Test valid schema passes validation
       - Test missing required field detection
       - Test incorrect field type detection
       - Test verification_status value validation
       - Test files_modified array validation
       - Test deviations array structure
  </action>
  <verify>bash test/adapter-context.test.sh 2>&1 | grep -E "tests passed" | tail -1</verify>
  <done>Complete test suite with 30+ tests covering all Phase 2 enhancements</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests and edge cases</name>
  <files>test/adapter-context.test.sh</files>
  <action>
    Add integration and edge case tests:

    1. End-to-end integration tests (4-5 tests):
       - Test complete flow: task → adapter → prompt with rules and pruning
       - Test complete flow: specialist output → parsing → validation → JSON
       - Test realistic Python specialist output with deviations
       - Test realistic TypeScript specialist output
       - Test fallback flow when specialist returns garbage

    2. Security and edge cases (4-5 tests):
       - Test prompt injection prevention (malicious file paths)
       - Test handling of special characters in output
       - Test extremely large output handling
       - Test Unicode and emoji in specialist output
       - Test concurrent parsing (if applicable)

    3. Add test summary that shows:
       - Total tests by category
       - Pass/fail counts
       - Coverage of ADPT requirements (ADPT-01 through ADPT-06)
  </action>
  <verify>bash test/adapter-context.test.sh | tail -10</verify>
  <done>Test suite complete with integration tests and comprehensive coverage</done>
</task>

</tasks>

<verification>
# Test file exists and is executable
test -f test/adapter-context.test.sh && test -x test/adapter-context.test.sh && echo "✓ Test file exists and executable"

# Run tests and check all pass
bash test/adapter-context.test.sh 2>&1 | grep -q "0 failed" && echo "✓ All tests pass"

# Check test count (should be 30+)
TEST_COUNT=$(bash test/adapter-context.test.sh 2>&1 | grep -oE "[0-9]+ tests passed" | grep -oE "[0-9]+")
[ "$TEST_COUNT" -ge 30 ] && echo "✓ $TEST_COUNT tests (30+ required)"
</verification>

<success_criteria>
- Test suite has 30+ tests covering all Phase 2 enhancements
- All tests pass (0 failures)
- Context pruning validated (8+ tests)
- GSD rule injection validated (6+ tests)
- Multi-layer parsing validated (10+ tests)
- Deviation extraction validated (8+ tests)
- Schema validation tested (6+ tests)
- Integration tests demonstrate end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapters-context-translation/02-03-SUMMARY.md`
</output>