---
phase: 02-adapters-context-translation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [agents/gsd-executor.md]
autonomous: true
must_haves:
  truths:
    - "gsd_result_adapter() attempts JSON parsing first, then falls back to heuristic text extraction"
    - "Result adapter validates required fields exist and have correct types"
    - "Deviations are extracted from specialist output and classified by GSD rule"
    - "Parsing gracefully degrades through multiple fallback layers"
  artifacts:
    - path: "agents/gsd-executor.md"
      provides: "Enhanced gsd_result_adapter() with multi-layer parsing and validation"
      contains: "parse_specialist_output_multilayer|validate_adapter_result|extract_deviations"
  key_links:
    - from: "gsd_result_adapter()"
      to: "parse_specialist_output_multilayer()"
      via: "function call for robust parsing"
      pattern: "parse_specialist_output_multilayer"
    - from: "gsd_result_adapter()"
      to: "extract_deviations()"
      via: "function call after parsing"
      pattern: "extract_deviations.*specialist_output"
---

<objective>
Enhance gsd_result_adapter() with multi-layer parsing, schema validation, and deviation extraction to reliably parse varied specialist outputs.

Purpose: Specialists output in different formats; adapter needs robust parsing with graceful degradation
Output: Enhanced gsd_result_adapter() that handles JSON, text, and edge cases while extracting deviations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapters-context-translation/02-RESEARCH.md

# Existing implementation from Phase 1
@agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-layer parsing function</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Add parse_specialist_output_multilayer() helper function BEFORE gsd_result_adapter():

    1. Implement 3-layer parsing strategy:
       - Layer 1: Try JSON extraction with markdown code blocks and direct JSON objects
       - Layer 2: Heuristic text extraction using regex patterns
       - Layer 3: Fallback to expected files

    2. Handle multiple output variations:
       - JSON in markdown code blocks (```json...```)
       - Direct JSON objects in text
       - Structured text with headers (FILES MODIFIED:, VERIFICATION:, etc.)
       - Bullet lists of files
       - Natural language descriptions

    Use the implementation from research (02-RESEARCH.md lines 384-453) as the base.
    Ensure all regex patterns handle common file extensions.
  </action>
  <verify>grep -A 10 "parse_specialist_output_multilayer()" agents/gsd-executor.md | head -15</verify>
  <done>Multi-layer parsing function exists with JSON, heuristic, and fallback layers</done>
</task>

<task type="auto">
  <name>Task 2: Add deviation extraction function</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Add extract_deviations() helper function AFTER parse_specialist_output_multilayer():

    1. Extract deviations from specialist output:
       - Check for explicit JSON deviations field
       - Pattern match for Rule 1 bugs (fixed bug, corrected error)
       - Pattern match for Rule 2 missing (added validation, error handling)
       - Pattern match for Rule 3 blocking (blocked, dependency issue)

    2. Return deviations as JSON array for consistency

    Use the implementation from research (02-RESEARCH.md lines 462-499).
    Ensure patterns match GSD's 4 deviation rule categories.
  </action>
  <verify>grep -A 5 "extract_deviations()" agents/gsd-executor.md | head -10</verify>
  <done>Deviation extraction function identifies and classifies deviations by GSD rule</done>
</task>

<task type="auto">
  <name>Task 3: Add schema validation and integrate all enhancements</name>
  <files>agents/gsd-executor.md</files>
  <action>
    1. Add validate_adapter_result() function AFTER extract_deviations():
       - Check JSON validity
       - Verify required fields (files_modified, verification_status, commit_message)
       - Validate field types (arrays vs strings)
       - Check verification_status values (passed/failed/unknown)

    2. Modify gsd_result_adapter() to use all new functions:
       - Call parse_specialist_output_multilayer() for robust parsing
       - Call extract_deviations() to get deviation array
       - Call validate_adapter_result() to verify schema
       - Add deviations to the final JSON output
       - Keep existing fallback to adapter_error_fallback() on failure

    Use validation implementation from research (02-RESEARCH.md lines 508-546).
    Ensure gsd_result_adapter() returns valid JSON with deviations field.
  </action>
  <verify>grep -q "validate_adapter_result" agents/gsd-executor.md && grep -q "extract_deviations" agents/gsd-executor.md && echo "✓ All functions integrated"</verify>
  <done>Result adapter uses multi-layer parsing, validates schema, and extracts deviations</done>
</task>

</tasks>

<verification>
# New functions exist
grep -q "parse_specialist_output_multilayer()" agents/gsd-executor.md && echo "✓ Multi-layer parsing exists"
grep -q "extract_deviations()" agents/gsd-executor.md && echo "✓ Deviation extraction exists"
grep -q "validate_adapter_result()" agents/gsd-executor.md && echo "✓ Schema validation exists"

# Functions are integrated
grep "gsd_result_adapter()" -A 30 agents/gsd-executor.md | grep -q "parse_specialist_output_multilayer" && echo "✓ Parser integrated"
grep "gsd_result_adapter()" -A 30 agents/gsd-executor.md | grep -q "extract_deviations" && echo "✓ Deviations integrated"
</verification>

<success_criteria>
- Multi-layer parsing handles JSON, text, and edge cases
- Deviations are extracted and classified by GSD rule
- Schema validation ensures required fields are present
- Parsing gracefully degrades through fallback layers
- Result adapter returns valid JSON with deviations field
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapters-context-translation/02-02-SUMMARY.md`
</output>